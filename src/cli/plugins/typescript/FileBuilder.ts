import fs from "fs";
import path from "path";

import {fromRootPath, getResolvePath} from "@cli/resolvers/path";

import {PackageName, SystemDir} from "@typing/app";
import {ReadonlyConfig} from "@typing/config";

export default abstract class FileBuilder {
    private _file?: string;

    protected abstract filename(): string;

    protected abstract template(): string;

    public static make<T extends FileBuilder>(this: new (config: ReadonlyConfig) => T, config: ReadonlyConfig): T {
        return new this(config).build();
    }

    protected constructor(protected readonly config: ReadonlyConfig) {}

    protected content(): string {
        return this.template().replaceAll(":package", PackageName);
    }

    protected withBanner(): boolean {
        return true;
    }

    protected file(): URL {
        return new URL(`./${this.filename()}`, this.url());
    }

    protected url(): string {
        return import.meta.url;
    }

    protected readFile(): string {
        return (this._file ??= fs.readFileSync(this.file(), {encoding: "utf-8"}));
    }

    public build(): this {
        const systemDirPath = getResolvePath(fromRootPath(this.config, SystemDir));

        let content = this.content().replaceAll("// prettier-ignore", "");

        if (this.withBanner()) {
            const banner = "// This file is automatically generated. \n\n";

            content = `${banner}${content}`;
        }

        fs.mkdirSync(systemDirPath, {recursive: true});

        fs.writeFileSync(path.join(systemDirPath, this.filename()), content);

        return this;
    }
}
