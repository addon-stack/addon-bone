import {isBackground} from "@adnbn/browser";

import RelayPermission from "@relay/RelayPermission";
import {ProxyRelay, type ProxyRelayParams} from "@relay/providers";

import {DeepAsyncProxy} from "@typing/helpers";
import {TransportDictionary, TransportType} from "@typing/transport";
import {RelayDefinition, RelayMethod, RelayOptions, RelayOptionsMap, RelayUnresolvedDefinition} from "@typing/relay";

export {RelayMethod};
export type {RelayDefinition, RelayUnresolvedDefinition};

export const defineRelay = <T extends TransportType>(options: RelayDefinition<T>): RelayDefinition<T> => {
    return options;
};

const getRelayOptionsMap = (): RelayOptionsMap => {
    const relays: RelayOptionsMap = new Map();

    try {
        // @ts-expect-error: __ADNBN_RELAY_OPTIONS__ is a virtual variable generated by the bundler `src/cli/plugins/content/index.ts`
        Object.entries<RelayOptions>(__ADNBN_RELAY_OPTIONS__).forEach(([key, value]) => relays.set(key, value));
    } catch (e) {
        console.error("Failed getting relays: ", e);
    }

    return relays;
};

export const getRelay = <N extends Extract<keyof TransportDictionary, string>>(
    name: N,
    params: ProxyRelayParams
): DeepAsyncProxy<TransportDictionary[N]> => {
    const options = getRelayOptionsMap().get(name);

    if (!options) {
        throw new Error(`Failed to get relay "${name}"`);
    }

    return new ProxyRelay(name, options, params).get();
};

try {
    const options = getRelayOptionsMap();

    if (options.size > 0 && isBackground()) {
        RelayPermission.init(options).catch(e => console.error("Failed to initialize relay permissions: ", e));
    }
} catch (e) {
}
